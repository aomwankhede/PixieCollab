var O=function(){this.parse=function(I,x){var m=/\r\n|\r|\n/,h=Date.now(),n=0,t=I.split(m),a=!1,r=[],l=[];function i(c,b){l.push({message:c,line:n+1,col:b})}var s=t[n],e=s.length,o="WEBVTT",d=0,u=o.length;for(s[0]==="\uFEFF"&&(d=1,u+=1),(e<u||s.indexOf(o)!==0+d||e>u&&s[u]!==" "&&s[u]!=="	")&&i('No valid signature. (File needs to start with "WEBVTT".)'),n++;t[n]!=""&&t[n]!=null;){if(i("No blank line after the signature."),t[n].indexOf("-->")!=-1){a=!0;break}n++}for(;t[n]!=null;){for(var f;!a&&t[n]=="";)n++;if(!a&&t[n]==null)break;f={id:"",startTime:0,endTime:0,pauseOnExit:!1,direction:"horizontal",snapToLines:!0,linePosition:"auto",textPosition:50,size:100,alignment:"middle",text:"",tree:null};var g=!0;if(t[n].indexOf("-->")==-1){if(f.id=t[n],/^NOTE($|[ \t])/.test(f.id)){for(n++;t[n]!=""&&t[n]!=null;)t[n].indexOf("-->")!=-1&&i("Cannot have timestamp in a comment."),n++;continue}if(n++,t[n]==""||t[n]==null){i("Cue identifier cannot be standalone.");continue}t[n].indexOf("-->")==-1&&(g=!1,i("Cue identifier needs to be followed by timestamp."))}a=!1;var p=new w(t[n],i),v=0;if(r.length>0&&(v=r[r.length-1].startTime),g&&!p.parse(f,v)){for(f=null,n++;t[n]!=""&&t[n]!=null;){if(t[n].indexOf("-->")!=-1){a=!0;break}n++}continue}for(n++;t[n]!=""&&t[n]!=null;){if(t[n].indexOf("-->")!=-1){i("Blank line missing before cue."),a=!0;break}f.text!=""&&(f.text+=`
`),f.text+=t[n],n++}var T=new y(f.text,i,x);f.tree=T.parse(f.startTime,f.endTime),r.push(f)}return r.sort(function(c,b){return c.startTime<b.startTime?-1:c.startTime>b.startTime?1:c.endTime>b.endTime?-1:c.endTime<b.endTime?1:0}),{cues:r,errors:l,time:Date.now()-h}}},w=function(n,x){var m=/[\u0020\t\f]/,h=/[^\u0020\t\f]/,n=n,t=0,a=function(e){x(e,t+1)};function r(e){for(;n[t]!=null&&e.test(n[t]);)t++}function l(e){for(var o="";n[t]!=null&&e.test(n[t]);)o+=n[t],t++;return o}function i(){var e="minutes",o,d,u,f;if(n[t]==null){a("No timestamp found.");return}if(!/\d/.test(n[t])){a("Timestamp must start with a character in the range 0-9.");return}if(o=l(/\d/),(o.length>2||parseInt(o,10)>59)&&(e="hours"),n[t]!=":"){a("No time unit separator found.");return}if(t++,d=l(/\d/),d.length!=2){a("Must be exactly two digits.");return}if(e=="hours"||n[t]==":"){if(n[t]!=":"){a("No seconds found or minutes is greater than 59.");return}if(t++,u=l(/\d/),u.length!=2){a("Must be exactly two digits.");return}}else u=d,d=o,o="0";if(n[t]!="."){a('No decimal separator (".") found.');return}if(t++,f=l(/\d/),f.length!=3){a("Milliseconds must be given in three digits.");return}if(parseInt(d,10)>59){a("You cannot have more than 59 minutes.");return}if(parseInt(u,10)>59){a("You cannot have more than 59 seconds.");return}return parseInt(o,10)*60*60+parseInt(d,10)*60+parseInt(u,10)+parseInt(f,10)/1e3}function s(e,o){for(var d=e.split(m),u=[],f=0;f<d.length;f++)if(d[f]!=""){var g=d[f].indexOf(":"),p=d[f].slice(0,g);if(value=d[f].slice(g+1),u.indexOf(p)!=-1&&a("Duplicate setting."),u.push(p),value==""){a("No value for setting defined.");return}if(p=="vertical"){if(value!="rl"&&value!="lr"){a("Writing direction can only be set to 'rl' or 'rl'.");continue}o.direction=value}else if(p=="line"){if(!/\d/.test(value)){a("Line position takes a number or percentage.");continue}if(value.indexOf("-",1)!=-1){a("Line position can only have '-' at the start.");continue}if(value.indexOf("%")!=-1&&value.indexOf("%")!=value.length-1){a("Line position can only have '%' at the end.");continue}if(value[0]=="-"&&value[value.length-1]=="%"){a("Line position cannot be a negative percentage.");continue}if(value[value.length-1]=="%"){if(parseInt(value,10)>100){a("Line position cannot be >100%.");continue}o.snapToLines=!1}o.linePosition=parseInt(value,10)}else if(p=="position"){if(value[value.length-1]!="%"){a("Text position must be a percentage.");continue}if(parseInt(value,10)>100){a("Size cannot be >100%.");continue}o.textPosition=parseInt(value,10)}else if(p=="size"){if(value[value.length-1]!="%"){a("Size must be a percentage.");continue}if(parseInt(value,10)>100){a("Size cannot be >100%.");continue}o.size=parseInt(value,10)}else if(p=="align"){var v=["start","middle","end","left","right"];if(v.indexOf(value)==-1){a("Alignment can only be set to one of "+v.join(", ")+".");continue}o.alignment=value}else a("Invalid setting.")}}this.parse=function(e,o){if(r(m),e.startTime=i(),e.startTime!=null){if(e.startTime<o&&a("Start timestamp is not greater than or equal to start timestamp of previous cue."),h.test(n[t])&&a("Timestamp not separated from '-->' by whitespace."),r(m),n[t]!="-"){a("No valid timestamp separator found.");return}if(t++,n[t]!="-"){a("No valid timestamp separator found.");return}if(t++,n[t]!=">"){a("No valid timestamp separator found.");return}if(t++,h.test(n[t])&&a("'-->' not separated from timestamp by whitespace."),r(m),e.endTime=i(),e.endTime!=null)return e.endTime<=e.startTime&&a("End timestamp is not greater than start timestamp."),h.test(n[t]),r(m),s(n.substring(t),e),!0}},this.parseTimestamp=function(){var e=i();if(n[t]!=null){a("Timestamp must not have trailing characters.");return}return e}},y=function(h,x,m){var h=h,n=0,t=function(r){m!="metadata"&&x(r,n+1)};this.parse=function(r,l){var i={children:[]},s=i,e=[];function o(v){s.children.push({type:"object",name:v[1],classes:v[2],children:[],parent:s}),s=s.children[s.children.length-1]}function d(v){for(var T=s;T;){if(T.name==v)return!0;T=T.parent}}for(;h[n]!=null;){var u=a();if(u[0]=="text")s.children.push({type:"text",value:u[1],parent:s});else if(u[0]=="start tag"){m=="chapters"&&t("Start tags not allowed in chapter title text.");var f=u[1];f!="v"&&f!="lang"&&u[3]!=""&&t("Only <v> and <lang> can have an annotation."),f=="c"||f=="i"||f=="b"||f=="u"||f=="ruby"||f=="rt"&&s.name=="ruby"?o(u):f=="v"?(d("v")&&t("<v> cannot be nested inside itself."),o(u),s.value=u[3],u[3]||t("<v> requires an annotation.")):f=="lang"?(o(u),s.value=u[3]):t("Incorrect start tag.")}else if(u[0]=="end tag")m=="chapters"&&t("End tags not allowed in chapter title text."),u[1]==s.name?s=s.parent:u[1]=="ruby"&&s.name=="rt"?s=s.parent.parent:t("Incorrect end tag.");else if(u[0]=="timestamp"){m=="chapters"&&t("Timestamp not allowed in chapter title text.");var g=new w(u[1],t),p=g.parseTimestamp();p!=null&&((p<=r||p>=l)&&t("Timestamp must be between start timestamp and end timestamp."),e.length>0&&e[e.length-1]>=p&&t("Timestamp must be greater than any previous timestamp."),s.children.push({type:"timestamp",value:p,parent:s}),e.push(p))}}for(;s.parent;)s.name!="v"&&t("Required end tag missing."),s=s.parent;return i};function a(){for(var r="data",l="",i="",s=[];h[n-1]!=null||n==0;){var e=h[n];if(r=="data")if(e=="&")i=e,r="escape";else if(e=="<"&&l=="")r="tag";else{if(e=="<"||e==null)return["text",l];l+=e}else if(r=="escape")if(e=="&")t("Incorrect escape."),l+=i,i=e;else if(/[abglmnsprt]/.test(e))i+=e;else if(e==";")i=="&amp"?l+="&":i=="&lt"?l+="<":i=="&gt"?l+=">":i=="&lrm"?l+="‎":i=="&rlm"?l+="‏":i=="&nbsp"?l+=" ":(t("Incorrect escape."),l+=i+";"),r="data";else{if(e=="<"||e==null)return t("Incorrect escape."),l+=i,["text",l];t("Incorrect escape."),l+=i+e,r="data"}else if(r=="tag")if(e=="	"||e==`
`||e=="\f"||e==" ")r="start tag annotation";else if(e==".")r="start tag class";else if(e=="/")r="end tag";else if(/\d/.test(e))l=e,r="timestamp tag";else{if(e==">"||e==null)return e==">"&&n++,["start tag","",[],""];l=e,r="start tag"}else if(r=="start tag")if(e=="	"||e=="\f"||e==" ")r="start tag annotation";else if(e==`
`)i=e,r="start tag annotation";else if(e==".")r="start tag class";else{if(e==">"||e==null)return e==">"&&n++,["start tag",l,[],""];l+=e}else if(r=="start tag class")if(e=="	"||e=="\f"||e==" ")s.push(i),i="",r="start tag annotation";else if(e==`
`)s.push(i),i=e,r="start tag annotation";else if(e==".")s.push(i),i="";else{if(e==">"||e==null)return e==">"&&n++,s.push(i),["start tag",l,s,""];i+=e}else if(r=="start tag annotation"){if(e==">"||e==null)return e==">"&&n++,i=i.split(/[\u0020\t\f\r\n]+/).filter(function(o){if(o)return!0}).join(" "),["start tag",l,s,i];i+=e}else if(r=="end tag"){if(e==">"||e==null)return e==">"&&n++,["end tag",l];l+=e}else if(r=="timestamp tag"){if(e==">"||e==null)return e==">"&&n++,["timestamp",l];l+=e}else t("Never happens.");n++}}};export{O as default};
